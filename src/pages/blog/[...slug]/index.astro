---
import { getCollection, type CollectionEntry } from "astro:content";
import PostDetails from "@/layouts/PostDetails.astro";
import { getPath } from "@/utils/getPath";
import getSortedPosts from "@/utils/getSortedPosts";

export interface Props {
  post: CollectionEntry<"blog">;
}

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => !data.draft && !data.unlisted);
  const postResult = posts.map((post) => ({
    params: { slug: getPath(post.id, post.filePath, false) },
    props: { post },
  }));

  // Also include unlisted posts so they can be accessed via direct URL
  const unlistedPosts = await getCollection("blog", ({ data }) => !data.draft && data.unlisted);
  const unlistedResult = unlistedPosts.map((post) => ({
    params: { slug: getPath(post.id, post.filePath, false) },
    props: { post },
  }));

  return [...postResult, ...unlistedResult];
}

let post = Astro.props.post as CollectionEntry<"blog"> | undefined;
const slug = Astro.params.slug;

// In server mode, getStaticPaths is ignored, so we need to look up the post dynamically
if (!post && slug) {
  const allPosts = await getCollection("blog");
  
  const foundPost = allPosts.find((p) => {
    const postSlug = getPath(p.id, p.filePath, false);
    // Remove leading slash for comparison
    const normalizedPostSlug = postSlug.replace(/^\//, '');
    
    // Handle various URL encoding scenarios
    let comparisonSlugs = [slug];
    
    // Try decoded versions
    try {
      comparisonSlugs.push(decodeURIComponent(slug));
      comparisonSlugs.push(decodeURI(slug));
    } catch (e) {
      // Ignore decode errors
    }
    
    // Handle double dash normalization that might happen in URL processing
    comparisonSlugs.push(slug.replace(/---/g, '--'));
    comparisonSlugs.push(slug.replace(/--/g, '-'));
    
    return comparisonSlugs.includes(normalizedPostSlug);
  });
  
  if (foundPost) {
    post = foundPost;
  }
}

// Return 404 if post not found
if (!post) {
  return new Response(null, { status: 404 });
}

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
---

<PostDetails post={post} posts={sortedPosts} />
